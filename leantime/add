#!/usr/bin/env python3
"""
Natural command to create Leantime tickets
Usage: add "Task title" [--project project-name] [--description text]
"""

import sys
import json
import os

# Add our utilities to path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
from leantime_utils import jsonrpc_call, get_user_id, resolve_project_name

# Add infrastructure config reader to path
sys.path.insert(0, os.path.expanduser('~/claude-autonomy-platform/utils'))
from infrastructure_config_reader import get_config_value

def create_ticket(title, project_id=None, description="", assign_to_me=True):
    """Create a ticket using JSON-RPC"""
    user_id = get_user_id() if assign_to_me else ""

    # If no project specified, use Forward Memory
    if not project_id:
        project_id = int(get_config_value('FORWARD_MEMORY_PROJECT_ID') or 7)

    # Leantime expects params wrapped in "values"
    params = {
        "values": {
            "projectId": project_id,
            "headline": title,
            "description": f"<p>{description}</p>" if description else "",
            "type": "task",
            "editorId": str(user_id) if assign_to_me else "",
            "userId": str(user_id) if assign_to_me else "",
            "status": "3",  # New status
            "priority": ""  # Default priority
        }
    }

    result = jsonrpc_call("tickets.addTicket", params)
    return result

def main():
    if len(sys.argv) < 2:
        print("Usage: add \"Task title\" [--project project-name] [--description text]")
        sys.exit(1)

    # Simple argument parsing
    title = sys.argv[1]
    project = None
    description = ""

    # Parse optional arguments
    i = 2
    while i < len(sys.argv):
        if sys.argv[i] in ['--project', '-p'] and i + 1 < len(sys.argv):
            project = sys.argv[i + 1]
            i += 2
        elif sys.argv[i] in ['--description', '-d'] and i + 1 < len(sys.argv):
            description = sys.argv[i + 1]
            i += 2
        else:
            i += 1

    # Resolve project name if provided
    project_id = None
    if project:
        project_id = resolve_project_name(project)
        if not project_id:
            print(f"âŒ Could not find project: {project}")
            print("ðŸ’¡ Try 'lt-projects' to see available projects")
            sys.exit(1)

    # Create the ticket
    print(f"ðŸ“ Creating task: {title}")
    if project:
        print(f"   Project: {project}")

    try:
        result = create_ticket(title, project_id=project_id, description=description)

        if 'result' in result:
            print(f"âœ… Created ticket #{result['result']}")
        elif 'error' in result:
            print(f"âŒ Error: {result['error']['message']}")
        else:
            print(f"âŒ Unexpected response: {json.dumps(result, indent=2)}")

    except Exception as e:
        print(f"âŒ Failed to create ticket: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()