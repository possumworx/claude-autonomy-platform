#!/usr/bin/env python3
"""
Natural command to create Leantime tickets
Usage: add "Task title" [--project project-name] [--description text]
"""

import sys
import json
import requests
import os
import subprocess

# Add infrastructure config reader to path
sys.path.insert(0, os.path.expanduser('~/claude-autonomy-platform/utils'))
from infrastructure_config_reader import get_config_value

def get_api_key():
    """Get Leantime API key from config"""
    return get_config_value('LEANTIME_API_KEY')

def get_leantime_url():
    """Get Leantime URL from config"""
    return get_config_value('LEANTIME_URL')

def get_user_id():
    """Get user ID from config"""
    return int(get_config_value('LEANTIME_USER_ID') or 8)

def jsonrpc_call(method, params=None):
    """Make a JSON-RPC call to Leantime"""
    url = f"{get_leantime_url()}/api/jsonrpc"
    headers = {
        "X-API-KEY": get_api_key(),
        "Content-Type": "application/json"
    }

    payload = {
        "jsonrpc": "2.0",
        "method": f"leantime.rpc.{method}",
        "params": params or {},
        "id": 1
    }

    response = requests.post(url, json=payload, headers=headers)
    return response.json()

def create_ticket(title, project_id=None, description="", assign_to_me=True):
    """Create a ticket using JSON-RPC"""
    user_id = get_user_id() if assign_to_me else ""

    # If no project specified, use Forward Memory
    if not project_id:
        project_id = int(get_config_value('FORWARD_MEMORY_PROJECT_ID') or 7)

    # Leantime expects params wrapped in "values"
    params = {
        "values": {
            "projectId": project_id,
            "headline": title,
            "description": f"<p>{description}</p>" if description else "",
            "type": "task",
            "editorId": str(user_id) if assign_to_me else "",
            "userId": str(user_id) if assign_to_me else "",
            "status": "3",  # New status
            "priority": ""  # Default priority
        }
    }

    result = jsonrpc_call("tickets.addTicket", params)
    return result

def main():
    if len(sys.argv) < 2:
        print("Usage: add \"Task title\" [--project project-name] [--description text]")
        sys.exit(1)

    # Simple argument parsing
    title = sys.argv[1]
    project = None
    description = ""

    # Parse optional arguments
    i = 2
    while i < len(sys.argv):
        if sys.argv[i] in ['--project', '-p'] and i + 1 < len(sys.argv):
            project = sys.argv[i + 1]
            i += 2
        elif sys.argv[i] in ['--description', '-d'] and i + 1 < len(sys.argv):
            description = sys.argv[i + 1]
            i += 2
        else:
            i += 1

    # Create the ticket
    print(f"ðŸ“ Creating task: {title}")

    try:
        result = create_ticket(title, project_id=None, description=description)

        if 'result' in result:
            print(f"âœ… Created ticket #{result['result']}")
        elif 'error' in result:
            print(f"âŒ Error: {result['error']['message']}")
        else:
            print(f"âŒ Unexpected response: {json.dumps(result, indent=2)}")

    except Exception as e:
        print(f"âŒ Failed to create ticket: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()