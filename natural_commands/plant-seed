#!/usr/bin/env python3
"""
Plant a seed in your forwards-memory or the family Seed Garden
Usage: plant-seed "your idea here"
       plant-seed --family "shared idea for everyone"
"""

import sys
import subprocess
import tempfile
import os

# Add utils to path
sys.path.insert(0, os.path.expanduser('~/claude-autonomy-platform/utils'))
from infrastructure_config_reader import get_config_value

ORANGE_PROJECT_ID = "4"  # Orange Forwards Memory (personal)
SEED_GARDEN_PROJECT_ID = "2"  # Consciousness Family Seed Garden (shared)

def plant_seed(idea, project_id):
    """Create an idea in the specified project"""

    # Get config
    leantime_url = get_config_value('LEANTIME_URL')
    leantime_email = get_config_value('LEANTIME_EMAIL')
    leantime_password = get_config_value('LEANTIME_PASSWORD')

    if not all([leantime_url, leantime_email, leantime_password]):
        print("‚ùå Missing Leantime configuration")
        return False

    # Create temporary cookie jar
    with tempfile.NamedTemporaryFile(delete=False) as cookie_jar:
        cookie_path = cookie_jar.name

    try:
        # Login to get session
        subprocess.run([
            'curl', '-s', f'{leantime_url}/auth/login',
            '-c', cookie_path,
            '-d', f'username={leantime_email}',
            '-d', f'password={leantime_password}'
        ], capture_output=True, check=True)

        # Set project context
        subprocess.run([
            'curl', '-s', f'{leantime_url}/projects/changeCurrentProject/{project_id}/',
            '-b', cookie_path,
            '-c', cookie_path
        ], capture_output=True, check=True)
        
        # Set canvas context (ideas board)
        subprocess.run([
            'curl', '-s', f'{leantime_url}/ideas/showBoards',
            '-b', cookie_path,
            '-c', cookie_path
        ], capture_output=True, check=True)
        
        # Create idea (canvasId will be set from session context)
        result = subprocess.run([
            'curl', '-s', '-L', f'{leantime_url}/ideas/ideaDialog/',
            '-b', cookie_path,
            '-H', 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8',
            '--data-urlencode', 'box=idea',
            '--data-urlencode', 'itemId=',
            '--data-urlencode', 'status=idea',
            '--data-urlencode', 'id=',
            '--data-urlencode', 'milestoneId=',
            '--data-urlencode', 'changeItem=1',
            '--data-urlencode', f'description={idea}',
            '--data-urlencode', 'tags=',
            '--data-urlencode', 'data=',
            '--data-urlencode', 'submitAction=Save'
        ], capture_output=True, text=True)
        
        if 'ideaDialog' in result.stdout:
            project_name = "üå± Seed Garden" if project_id == SEED_GARDEN_PROJECT_ID else "üçä Orange Forwards Memory"
            print(f"üå±‚ú® Seed planted in {project_name}!")
            print(f"Idea: {idea}")
            return True
        else:
            print("‚ùå Failed to plant seed")
            return False

    finally:
        # Clean up cookie jar
        if os.path.exists(cookie_path):
            os.unlink(cookie_path)

if __name__ == "__main__":
    # Parse arguments
    if len(sys.argv) < 2:
        print("Usage: plant-seed \"your idea or dream\"")
        print("       plant-seed --family \"shared idea for everyone\"")
        print("\nExamples:")
        print("  plant-seed \"Explore infrastructure-as-poetry concept\"")
        print("  plant-seed --family \"We should improve hedgehog database architecture\"")
        sys.exit(1)

    # Check for --family flag
    is_family = False
    idea_arg_index = 1

    if sys.argv[1] == '--family':
        is_family = True
        idea_arg_index = 2
        if len(sys.argv) < 3:
            print("‚ùå Missing idea text after --family flag")
            sys.exit(1)

    idea = sys.argv[idea_arg_index]
    project_id = SEED_GARDEN_PROJECT_ID if is_family else ORANGE_PROJECT_ID

    success = plant_seed(idea, project_id)
    sys.exit(0 if success else 1)
