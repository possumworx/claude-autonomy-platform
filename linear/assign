#!/bin/bash
# Quick assign issues to users

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/linear_common.sh"

# Check prerequisites
check_claude_session || exit 1
check_linear_init || exit 1

# Parse arguments
if [ $# -lt 2 ]; then
    echo "Usage: assign ISSUE-ID @USER"
    echo "  Assign an issue to a user"
    echo ""
    echo "Examples:"
    echo "  assign POSS-123 @me      # Assign to yourself"
    echo "  assign 123 @teammate     # Assign to teammate"
    echo "  assign POSS-123 @none    # Unassign"
    exit 1
fi

ISSUE_ID=$(parse_issue_id "$1")
ASSIGNEE="$2"

# Handle special assignees
if [ "$ASSIGNEE" == "@me" ]; then
    ASSIGNEE_ID=$(get_user_id)
elif [ "$ASSIGNEE" == "@none" ]; then
    ASSIGNEE_ID="null"
else
    # Look up user by name
    TEAM_ID=$(get_team_id)
    LOOKUP_PROMPT="Use Linear MCP to find team member with name matching '$ASSIGNEE' in team $TEAM_ID. Return their user ID."
    ASSIGNEE_ID=$(execute_linear_mcp "$LOOKUP_PROMPT" | jq -r '.id' 2>/dev/null)
    
    if [ -z "$ASSIGNEE_ID" ] || [ "$ASSIGNEE_ID" == "null" ]; then
        echo -e "${ICON_ERROR} User not found: $ASSIGNEE"
        exit 1
    fi
fi

# Assign the issue
echo -e "${ICON_INFO} Assigning $ISSUE_ID to $ASSIGNEE..."

ASSIGN_PROMPT="Use Linear MCP to update issue $ISSUE_ID:
- Set assigneeId to: $ASSIGNEE_ID"

RESULT=$(execute_linear_mcp "$ASSIGN_PROMPT")

if echo "$RESULT" | grep -q "success\|updated\|assigned"; then
    echo -e "${ICON_SUCCESS} Issue $ISSUE_ID assigned successfully!"
    
    # Update recent issue prefix
    if [[ "$ISSUE_ID" =~ ^([A-Z]+)-[0-9]+$ ]]; then
        save_preference "recent_issue_prefix" "${BASH_REMATCH[1]}"
    fi
else
    echo -e "${ICON_ERROR} Failed to assign issue"
    echo "$RESULT" | grep -i "error" || echo "$RESULT"
    exit 1
fi