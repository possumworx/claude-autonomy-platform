#!/bin/bash
# Natural command to update Linear issue status
# Usage: update-status <issue-id> <status>
# Status options: todo, in-progress, done, canceled

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
STATE_FILE="$SCRIPT_DIR/../data/linear_state.json"

# Check if state file exists and is initialized
if [ ! -f "$STATE_FILE" ] || [ "$(jq -r '.user.id' "$STATE_FILE" 2>/dev/null)" == "" ]; then
    echo "❌ Linear not initialized. Run 'linear/init' first!"
    exit 1
fi

# Parse arguments
if [ $# -lt 2 ]; then
    echo "Usage: update-status <issue-id> <status>"
    echo "Status options: todo, in-progress, in-review, done, canceled"
    echo "Example: update-status POSS-123 done"
    exit 1
fi

ISSUE_ID="$1"
STATUS="$2"

# Normalize status
STATUS_LOWER=$(echo "$STATUS" | tr '[:upper:]' '[:lower:]' | tr '-' ' ')

# Map status to state ID from our team's states
case "$STATUS_LOWER" in
    "todo")
        STATE_ID="a8154f4e-0a0b-4841-83ab-4db2e8dd9034"
        STATUS_NAME="Todo"
        ;;
    "in progress"|"progress")
        STATE_ID="a6e66d49-f0c9-4a21-997e-f20e06de226a"
        STATUS_NAME="In Progress"
        ;;
    "in review"|"review")
        STATE_ID="8252724b-f933-402a-b7f3-9897ab106bac"
        STATUS_NAME="In Review"
        ;;
    "done"|"completed")
        STATE_ID="3f06fdca-1b29-4200-bb97-ab654ca2650f"
        STATUS_NAME="Done"
        ;;
    "canceled"|"cancelled")
        STATE_ID="857fea47-a595-41a5-b90a-f726b4a640c1"
        STATUS_NAME="Canceled"
        ;;
    "backlog")
        STATE_ID="6ca2d4e3-2016-49dd-9ac5-58619ab9ad40"
        STATUS_NAME="Backlog"
        ;;
    *)
        echo "❌ Unknown status: $STATUS"
        echo "Valid statuses: todo, in-progress, in-review, done, canceled, backlog"
        exit 1
        ;;
esac

echo "Updating $ISSUE_ID to $STATUS_NAME..."

# Build the JSON payload
PAYLOAD=$(jq -n \
    --arg issueId "$ISSUE_ID" \
    --arg stateId "$STATE_ID" \
    '{
        issueIds: [$issueId],
        update: {
            stateId: $stateId
        }
    }')

# Update the issue using Claude with MCP
PROMPT="Please update the Linear issue status using mcp__linear__linear_bulk_update_issues with these parameters: $PAYLOAD"
RESULT=$(echo "$PROMPT" | claude --print --dangerously-skip-permissions 2>&1)

if echo "$RESULT" | grep -q -E "(Updated|successfully|Success)"; then
    echo "✅ Updated $ISSUE_ID to $STATUS_NAME"
else
    echo "❌ Failed to update issue"
    echo "$RESULT"
    exit 1
fi