#!/bin/bash
# Quick command to start working on an issue (move to In Progress and assign to self)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/linear_common.sh"

# Check prerequisites
check_linear_init || exit 1
check_claude_session || exit 1

if [ $# -lt 1 ]; then
    echo "Usage: start ISSUE-ID"
    echo ""
    echo "Moves issue to 'In Progress' and assigns it to you"
    echo ""
    echo "Example: start POSS-123"
    exit 1
fi

ISSUE_ID=$(parse_issue_id "$1")
USER_ID=$(get_user_id)

echo -e "${ICON_INFO} Starting work on: ${CYAN}${ISSUE_ID}${RESET}"

# Create prompt for Claude
PROMPT="Please help me start working on issue $ISSUE_ID:

1. First search for the issue using linear_search_issues with query \"$ISSUE_ID\"
2. Then use linear_bulk_update_issues to:
   - Set status to 'In Progress' 
   - Set assigneeId to \"$USER_ID\"

Show me confirmation of the updates."

# Execute via Claude MCP
echo -e "${YELLOW}Updating issue...${RESET}"
RESULT=$(execute_linear_mcp "$PROMPT")

# Check result
if echo "$RESULT" | grep -q -E "(Updated|Successfully|moved to In Progress|assigned to)"; then
    echo -e "\n${ICON_SUCCESS} ${GREEN}Started working on ${ISSUE_ID}!${RESET}"
    echo -e "  ${ICON_STATUS_PROGRESS} Status: In Progress"
    echo -e "  ${ICON_USER} Assigned to you"
    
    # Add a comment
    if command -v "${SCRIPT_DIR}/comment" &> /dev/null; then
        "${SCRIPT_DIR}/comment" "$ISSUE_ID" "Started working on this" &> /dev/null
    fi
else
    echo -e "\n${ICON_ERROR} ${RED}Failed to update issue${RESET}"
    echo "$RESULT" | head -10
    exit 1
fi