#!/bin/bash
# Show unassigned issues in your teams (team inbox)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/linear_common.sh"

# Check prerequisites
check_linear_init || exit 1
check_claude_session || exit 1

# Get team info
TEAM_ID=$(get_team_id)

print_header "${ICON_TASK} Team Inbox - Unassigned Issues" 60

# Create prompt
PROMPT="Please use Linear MCP linear_search_issues to find unassigned issues:
- teamIds: [\"$TEAM_ID\"]
- first: 30
- states: [\"Todo\", \"Backlog\"]

Filter for issues where assignee is null/unassigned.

Format results showing:
- Issue ID and title  
- Status and priority with icons
- Project name
- Created date
- Labels if any

Sort by priority (urgent first) then by created date (newest first)."

# Execute query
echo -e "${YELLOW}Fetching unassigned issues...${RESET}\n"
RESULT=$(execute_linear_mcp "$PROMPT")

# Display results
if echo "$RESULT" | grep -q -E "(issues found|No issues|[A-Z]+-[0-9]+)"; then
    echo "$RESULT"
    
    # Count results
    ISSUE_COUNT=$(echo "$RESULT" | grep -c -E "[A-Z]+-[0-9]+")
    echo -e "\n${BLUE}Total unassigned issues: ${ISSUE_COUNT}${RESET}"
else
    echo -e "${ICON_ERROR} Failed to fetch inbox"
    echo "$RESULT" | head -5
    exit 1
fi