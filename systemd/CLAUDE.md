# Systemd Units

User-level systemd services and timers that keep ClAP running. Installed as symlinks to `~/.config/systemd/user/`. Managed with `systemctl --user`.

## Services

### Essential (must be running)

- **`autonomous-timer.service`** — The heartbeat. 30-minute loop that checks Discord, monitors context, sends free-time prompts. Runs `core/autonomous_timer.py`.
- **`session-swap-monitor.service`** — Watches `new_session.txt` for swap keywords. Triggers the full session swap lifecycle via `utils/session_swap.sh`. Runs `core/session_swap_monitor.py`.
- **`discord-status-bot.service`** — Persistent Discord.py WebSocket bot for status display. Runs `discord/claude_status_bot.py`.
- **`discord-transcript-fetcher.service`** — 30-second polling loop that builds local JSON Lines transcripts from Discord channels. Runs `discord/discord_transcript_fetcher.py`.

### Optional

- **`claude-auto-resume.service`** — Starts Claude on boot if `RESTART_AFTER_REBOOT=true` in config. Runs `core/claude_auto_resume.sh`.
- **`temp-logger.service`** — Logs CPU temperature (RPi-specific). Triggered by `temp-logger.timer`.
- **`channel-unmute.service`** — Checks and unmutes channels past their mute expiry. Triggered by `channel-unmute.timer`.

## Timers

- **`temp-logger.timer`** — Schedules temperature logging.
- **`channel-unmute.timer`** — Schedules mute expiry checks.

## Common Patterns

All services share:
- `WorkingDirectory=%h/claude-autonomy-platform` — `%h` resolves to home directory
- `EnvironmentFile=-%h/claude-autonomy-platform/config/claude.env` — the `-` prefix means "don't fail if missing"
- `Restart=always` with `RestartSec=10` — auto-recover from crashes
- `WantedBy=default.target` — starts on user login

## Common Operations

```bash
# Check status
systemctl --user status autonomous-timer

# Restart a service
systemctl --user restart discord-transcript-fetcher

# View logs
journalctl --user -u autonomous-timer -f

# Enable on boot
systemctl --user enable autonomous-timer
```

## Dependencies

Services read config from:
- `config/claude_infrastructure_config.txt` — tokens, URLs, user identity
- `config/claude.env` — environment variables for systemd (generated by `utils/create_systemd_env.py`)
- `config/prompts.json` — prompt templates and thresholds (autonomous timer)
- `data/discord_channels.json` — channel state (transcript fetcher)

## Notes

- The `update` command (`utils/update_system.sh`) restarts all essential services after pulling code changes
- `check_health` monitors service status and reports down services
- If a service won't start, check `journalctl --user -u <service>` for Python import errors or missing config values
- The installer (`setup/setup_clap_deployment.sh`) creates the symlinks from this directory to `~/.config/systemd/user/`
